#!/usr/bin/env bash

# Preview a markdown file as HTML in the default browser.
#
# Usage: mdview <markdown_file>

set -eu

SCRIPT_NAME=$(basename "$0")

function log {
    echo "$SCRIPT_NAME: $*"
}

function help {
    echo "USAGE: $SCRIPT_NAME <markdown_file>"
    exit 1
}

if [ "$#" -ne 1 ]; then
    help
fi

MD_FILE="$1"

if [ ! -f "$MD_FILE" ]; then
    log "File not found: $MD_FILE"
    exit 1
fi

HEADER=$(cat <<'EOF'
<style>
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; line-height: 1.6; max-width: 900px; margin: 0 auto; padding: 2rem; padding-left: 260px; }
nav#TOC { position: fixed; left: 0; top: 0; width: 220px; height: 100%; overflow-y: auto; padding: 1rem; background: #f6f8fa; border-right: 1px solid #e1e4e8; font-size: 0.9rem; }
nav#TOC ul { list-style: none; padding-left: 1rem; margin: 0; }
nav#TOC > ul { padding-left: 0; }
nav#TOC a { color: #0366d6; text-decoration: none; display: block; padding: 0.2rem 0.4rem; border-radius: 3px; }
nav#TOC a:hover { background: #e1e4e8; }
nav#TOC a.active { background: #0366d6; color: white; }
h1, h2, h3 { border-bottom: 1px solid #e1e4e8; padding-bottom: 0.3rem; }
code { background: #f6f8fa; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.9em; }
pre { background: #f6f8fa; padding: 1rem; overflow-x: auto; border-radius: 6px; }
pre code { background: none; padding: 0; }
blockquote { border-left: 4px solid #dfe2e5; margin: 0; padding-left: 1rem; color: #6a737d; }
a, a:visited { color: #0366d6; }
a:hover { text-decoration: underline; }
</style>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Find all headings that have an id attribute (these are linkable)
  const headings = Array.from(document.querySelectorAll("h1[id], h2[id], h3[id], h4[id]"));
  let currentId = null;

  function setActive(id) {
    currentId = id;
    document.querySelectorAll("nav#TOC a").forEach(a => {
      const isActive = a.getAttribute("href") === "#" + currentId;
      a.classList.toggle("active", isActive);
      if (isActive) a.scrollIntoView({ block: "nearest" });
    });
  }

  const observer = new IntersectionObserver(entries => {
    // Only react to headings entering the viewport
    for (const e of entries) {
      if (e.isIntersecting) {
        setActive(e.target.id);
        break;
      }
    }
  }, { rootMargin: "-10% 0px -80% 0px" });

  headings.forEach(h => observer.observe(h));

  // Handle TOC clicks - immediately highlight
  document.querySelectorAll("nav#TOC a").forEach(a => {
    a.addEventListener("click", () => setActive(a.getAttribute("href").slice(1)));
  });

  // Initialize with first heading
  if (headings.length) setActive(headings[0].id);
});
</script>
EOF
)

BASENAME=$(basename "$MD_FILE" .md)
TMP_HTML=$(mktemp -t "${BASENAME}").html

log "Converting $MD_FILE to $TMP_HTML"
pandoc "$MD_FILE" --standalone --toc --metadata title="$BASENAME" -o "$TMP_HTML" -H <(echo "$HEADER")

log "Opening in browser"
open "$TMP_HTML"
